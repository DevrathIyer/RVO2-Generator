<html>
<head>
	<script type="text/javascript" src="lib/common.js"></script>
	<script type="text/javascript" src="lib/agent.js"></script>
	<script type="text/javascript" src="lib/kdtree.js"></script>
	<script type="text/javascript" src="lib/simulator.js"></script>
	<title>Simulator</title>

	<style type="text/css">
      canvas {
      	border: 1px dotted gray;
      	float: left;
      	margin-right: 2em;
      }

      label {
      	display: block;
      }

      body {
      	text-align: justify;
      	font-family: Verdana, Arial, serif;
      	font-size: smaller;
      	margin-right: 2em;
      }

      .clearfix {
      	clear: both;
      }

      #dump_area {
      	font-family: courier new, serif;
      	font-size: small;
      }
    </style>
</head>
<body>
	<canvas id="board" width="900" height="700">
		Your browser does not support canvas.  Please use a modern browser with HTML5 support.
	</canvas>

	<div id="params">
		<p id="intro">
		Algorithm for interactive navigation and planning of large numbers of agents in two-dimensional (crowded) environments.
		<br/>
		At runtime, each agent senses the environment independently and computes a collision-free motion based on the optimal
		reciprocal collision avoidance (ORCA) formalism.
		</p>

		<label for="agents"># agents</label>
		<input type="text" name="agents" id="agents" value="9" />

		<label for="radius">agent radius</label>
		<input type="text" name="radius" id="radius" value="20" />

		<input type="checkbox" name="obstacles" id="obstacles"> add obstacle (experimental)
		<br /><br />

		<label for="speed">simulation speed</label>
		<input type="range" min="0.1" max="1.0" step="0.1" value="0.3" name="speed" id="speed"/>
		<br />

		<input type="button" value="start new simulation >>" id="run" onclick="run()">

		<p id="dump_area">
		</p>
	</div>

	<div class="clearfix"></div>

	<script type="text/javascript">
		$ = function(id) {
			return document.getElementById(id);
		};

		var Board = function() {
			var canvas = document.getElementById('board');
			var ctx = canvas.getContext('2d');

			var w = canvas.width;
			var h = canvas.height;

			this.drawObstacles = function(simulator) {
				var obstacles = simulator.getObstacles();
			};

			this.drawAgents = function(simulator) {
				var numAgents = simulator.getNumAgents();

				for (var i=0; i<numAgents; i++) {
					ctx.fillStyle = "red";

					var pos = simulator.getAgentPosition(i);
					var radius = simulator.getAgentRadius(i);
					ctx.beginPath();
					ctx.arc(pos.x + w/2 - 2, pos.y + h/2 - 2, radius, 0, Math.PI * 2, true);
					ctx.fill();
				}
			};

			this.drawGoals = function(simulator) {
				ctx.strokeStyle = "rgb(200,200,200)";

				var numAgents = simulator.getNumAgents();
				for (var i=0; i<numAgents; i++) {
					var pos = simulator.getGoal(i);
					var radius = simulator.getAgentRadius(i);
					ctx.beginPath();
					ctx.arc(pos.x + w/2 - 2, pos.y + h/2 - 2, radius, 0, Math.PI * 2, true);
					ctx.stroke();
				}
			};

			this.draw = function(simulator) {
				this.reset();
				this.drawObstacles(simulator);
				this.drawAgents(simulator);
				this.drawGoals(simulator);
			}

			this.reset = function() {
				ctx.clearRect(0,0,w,h);
			}
		}

		var setPreferredVelocities = function(simulator) {
			var stopped = 0;
			var numAgents = simulator.getNumAgents();
		  for (var i = 0; i < numAgents; ++i) {
		    if (RVOMath.absSq(simulator.getGoal(i).minus(simulator.getAgentPosition(i))) < 60) {
		      // Agent is within three radii of its goal, change goal
		      new_x = Math.random()*(900)-(900)/2;
		      new_y = Math.random()*(700)-(700)/2;
		      simulator.setGoal(i,new Vector2(new_x,new_y));
		    }

		    simulator.setAgentPrefVelocity(i, RVOMath.normalize (simulator.getGoal(i).minus(simulator.getAgentPosition(i))));
		  }
  		return stopped;
		}

		var setupScenario = function(simulator)
		{
			// Specify global time step of the simulation.
			var speed = 500;
			simulator.setTimeStep(speed);

			// Specify default parameters for agents that are subsequently added.
			var velocity = new Vector2(1, 1);
			var radius = new Number($("radius").value); // TODO validate
			simulator.setAgentDefaults(
					400, // neighbor distance (min = radius * radius)
					30, // max neighbors
					600, // time horizon
					600, // time horizon obstacles
					radius, // agent radius
					6, // max speed
					velocity // default velocity
				);
			var NUM_AGENTS = $("agents").value;
			for (var i=0; i<NUM_AGENTS; i++) {
				var angle = i * (2*Math.PI) / NUM_AGENTS;
				x = Math.random()*(900)-(900)/2;
				y = Math.random()*(700)-(700)/2;
				simulator.addAgent(new Vector2 (x,y));
 			}

			// Create goals
			var goals = [];
			for (var i = 0; i < simulator.getNumAgents (); ++i) {
				new_x = Math.random()*(900)-(900)/2;
				new_y = Math.random()*(700)-(700)/2;
				goals.push(new Vector2(new_x,new_y));
			}
			simulator.addGoals(goals);

			// Add (polygonal) obstacle(s), specifying vertices in counterclockwise order.

			// Process obstacles so that they are accounted for in the simulation.
			simulator.processObstacles();
		}

		var simulator;
		var board = new Board();

		var interval;
		var run = function() {
			count = 0;
			content = "";
			simulator = Simulator.instance = new Simulator(); // not a real singleton (TODO)
			clearInterval(interval);
			board.reset();
			setupScenario(simulator);

			var step = function() {
				if(count > 108000)
				{
					clearInterval(interval);
					console.dir(content);
				}
				setPreferredVelocities(simulator);
				content += "frame" + count;
				for(var i = 0; i < simulator.getNumAgents(); i++)
				{
					 content += "\t" + simulator.getAgentPosition(i).x+450 + "\t" + simulator.getAgentPosition(i).y+350;
				}
				content += "\n";
				simulator.run();
				//board.draw(simulator);
				count++;
			}

			interval = setInterval(step, 5);
		}

		var dump = function() {
			$("dump_area").innerHTML = "";
			if (simulator && simulator.agents.length) {
				for (var i=0; i<simulator.agents.length; i++) {
					$("dump_area").innerHTML += "<b>AGENT " + i + "</b>" +
						" <b>position</b> => " + simulator.agents[i].position.x.toFixed(3) + "," + simulator.agents[i].position.y.toFixed(3) +
						" <b>dir</b> => " + simulator.agents[i].velocity.x.toFixed(3) + "," + simulator.agents[i].velocity.y.toFixed(3) + "<br />";
				}
			} else {
				$("dump_area").innerHTML += "No agent info was found. Please start a simulation.";
			}
		}

		function download(filename, text) {
		  var element = document.createElement('a');
		  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
		  element.setAttribute('download', filename);

		  element.style.display = 'none';
		  document.body.appendChild(element);

		  element.click();

		  document.body.removeChild(element);
		}

	</script>
</body>
</html>
